{% extends 'wwe2k16/base.html' %}
{% block title %}Add New Match{% endblock %}

{% block body %}
	<section>
		<div class="row">
			<div class="col s12 m8 offset-m2">
				<div class="card z-depth-5">
					<div class="card-content">
						<span class="card-title">Add New Match</span>
						{% csrf_token %}
						{% include 'wwe2k16/forms/template.html' %}
						{% include 'wwe2k16/forms/error.html' %}
						<div class="row">
							<div class="input-field col s12">
								<button class="btn waves-effect waves-light green lighten-1" id="submit">Add Match
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
{% endblock %}

{% block script %}
<script>
	function setAutocompleteData() {
		const chipData = $('#id_participants').material_chip('data');
		const customData = {};
		chipData.forEach(el => {
			customData[el.tag] = null;
		});
		console.log(customData);
		$('#id_winner').autocomplete({
			data: customData,
			minLength: 1,
		});
	}

	$(document).ready(() => {
		$(() => {
			$.ajax({
				type: 'GET',
				url: '/wwe2k16/api/wrestlers/',
				success: function(response) {
					var customData = {};
					response.forEach(el => {
						customData[el] = null;
					});
					$('#id_participants').material_chip({
						autocompleteOptions: {
							data: customData,
							limit: Infinity,
							minLength: 1,
						}
					});
				}
			});
		});
		$('#id_participants').on('chip.add', (e, chip) => {
			setAutocompleteData();
		});
		$('#id_participants').on('chip.delete', (e, chip) => {
			setAutocompleteData();
		});
		$('#submit').click((e) => {
			const chipData = $('#id_participants').material_chip('data');
			const options = [];
			chipData.forEach(el => {
				options.push(el.tag);
			});
			const event = $('#id_event').val();
			const championship = $('#id_championship').val();
			const match_type = $('#id_match_type').val();
			const winner = $('#id_winner').val();
			const csrfmiddlewaretoken = $('input[name=csrfmiddlewaretoken]').val();
			$.post("/wwe2k16/match/add/", {
				event,
				championship,
				match_type,
				winner,
				csrfmiddlewaretoken,
				participants_list: options,
			},
			function(response, status) {
				console.log(response);
			});
		});
	});
</script>
{% endblock %}